---
title: 计算机网络简记
date: 2021-07-10 20:35:56
tags: Internet


---

## 序言

因特网无疑是有史以来由人类创造、精心设计的最大系统，如何理解这种规模和复杂度惊人的系统呢，对此我们需要了解因特网的工作原理，理解与掌握某些指导原则和结构，以便探索计算机网络中那引人入胜又趣味盎然的事。因此，我们以Top-Down的模式开启对计算机网络的学习。最后以对HTTP网页的访问及响应的过程，作为对计算机网络应用的一次生命周期的漫游。

---

<!-- more -->

# Chapter 01 概述

## 1.1 互联网是什么

### 1.1.1 结构角度

广义上的结构角度来看，互联网由节点、边和协议构成

节点：主机节点和数据交换节点（中继器、交换机、路由器）

边：通信链路（接入网链路、主干链路）

协议：对等层实体在通讯过程中所遵循的规则的集合

### 1.1.2 服务角度

广义的服务角度来看，互联网由分布式应用进程和通信基础设施构成

通信基础设施：为分布式应用提供通信服务（网络API—TCP/UDP服务）

## 1.2 互联网的组成（功能角度）

### 1.2.1 网络边缘

主机：提供分布式进程

架构：C/S、P2P

服务：面向连接的TCP协议，无连接的UDP协议

### 1.2.2 网络核心

路由器：子网之间的分组的路由与转发

路由：根据路由算法得出源端到目标端的路径

转发：将分组从输入链路转移到输出链路

服务：路由器可以在网络层提供有连接的服务，区别于面向连接到服务

### 1.2.3 接入网

物理媒体 ：交换机、有线和无线链路、调制解调器(modem)

类型：以太网（Ethenet）和WLAN

## 1.3 网络功能的实现

### 1.3.1 协议层次

将复杂的网络功能，分解成一个个功能明确的层次协议来实现，上层协议通过层间接口使用下层协议所的服务，来执行本层的协议动作以实现本层的功能。

### 1.3.2 服务模型

上下层的信息交互，是通过服务访问点（SAP）使用原语（primitive）的形式

服务与协议的区别：服务（Service）是底层实体向上层实体提供它们之间的通信能力，是通过原语（primitive）来操作的，呈垂直结构。协议（protocol）是对等层实体（peer entity）之间在相互通信过程中，需要遵循的规则的集合，呈水平结构。

## 1.4 网络性能

### 1.4.1 延迟

分组到达链路的速率远超链路传输的速率

### 1.4.2 丢失

分组到达节点时，缓冲区已满，该分组就会被丢掉

### 1.4.3 吞吐量/流量强度

吞吐量：从源端到目标端之间的传输速率（即**单位时间内的有效比特的数量**）

流量强度：
$$
I=La/R
$$
其中，R为链路带宽(bps)，L为分组长度(bits)，a为分组达到队列的平均速率（期望的分组数量）

## 1.5 Internet协议栈

应用层：网络应用，为应用进程提供网络应用服务—FTP、SMTP、HTTP、DNS；

传输层：主机之间的数据传输，在网络层提供的端到端通信的基础上，细分为进程到进程，并向上层提供可靠的服务—TCP、UDP；

网络层：为数据报从源到目的选择路由，端到端的通信，不可靠—IP、路由协议；

链路层：相邻网络节点的数据传输，点到点的通信，可靠或不可靠—802.11(wifi)、802.3（Ethernet）；

物理层：在线路上传送bit；

## Chapter 02 应用层

## 2.1 应用架构

客户端-服务器模式（C/S，client/server）：服务器一直运行，有固定的IP地址和周知的端口好；客户端主动与服务器通信，可能为动态IP地址，不可直接与其他客户端通信。缺点是扩展性差。

对等模式（P2P，Peer  To Peer）：几乎没有一直运行的服务器，任意端系统之间都可以通信。缺点是难以管理。

混合体（客户端-服务器和对等体系结构 ）：根据功能需求来使用合适的架构，比如文件搜索使用C/S，文件传输使用P2P。比如即时通信，用户上线使用C/S，用户与用户聊天使用P2P。

## 2.2 进程通信协议

进程通信：不同主机，通过交换报文（Message）来通信—使用OS提供的通信服务，按照应用协议交换报文（借助传输层提供的服务）

分布式进程通信需要解决的问题（3个）（进程表示、寻址；传输层如何提供服务；应用层如何通信）

进程表示：IP + port + (pid) 标识不同进程

传输层提供服务：使用socket，包含IP和port，向指定的进程提供通信服务

应用层通信协议：编制程序，通过API调用网络基础设施提供的通信服务，传递报文，解析报文，实现应用时序

## 2.3 常用协议

### 2.3.1 Web和Http

Web页：由一些对象(Html、jpg等)构成

Html文件：包含了对若干对象的引用(URL)

URL格式：Prot://user:psw@www.someSchool.edu/someDept/pic.gif:port

​		协议名—Prot

​		用户口令—user:psw

​		主机名—www.someSchool.edu

​		路径名—someDept/pic.gif

​		端口—port

Http（超文本传输协议）— Web的应用层协议

客户端/服务器模式：客户请求、接收和显示Web对象的浏览器；服务器对请求进行响应，发送对象

HTTP报文格式

1. 两种类型的HTTP报文：请求、响应

2. HTTP请求报文：

   ​		ASCII（人能阅读），组成格式如下：

   ​		请求行—GET /somedir/page.htlm HTTP/1.1

   ​		首部行—Host：www.someschool.edu

   ​		首部行—User-agent：mozilla/4.0

   ​		首部行—connection：close

   ​		首部行—Accept-language：fr

   ​		（一个额外的换行回车符）

   ​		Entity Body（请求报文可能没有）

3. HTTP响应报文

   ​			同样由ASCII码组成，方便阅读，组成如下

   ​			状态行（协议版本、状态码和相应状态信息）— HTTP/1.1 200 OK\r\n

   ​			首部行—Connection close\r\n

   ​			首部行Date：Thu, 06 Aug 1998 12:00:15 GMT\r\n

   ​			首部行—Server：Apache/1.3.0 （Unix）\r\n

   ​			首部行—Last-Modified：Mon, 22 Jun 1998....\r\n

   ​			首部行—Content-Length：6821\r\n

   ​			首部行—Content—Type：text/html \r\n

   ​			\r\n

   ​			（数据，如请求的HTML文件）data data data data data data...

4. 方法类型

   HTTP/1.0—GET（客户端向服务器请求）、POST（客户端向服务器提交）、HEAD（客户端向服务器请求HTML的头部）

   HTTP/1.1—GET、POST、HEAD、PUT（将实体主机的文件上载到URL字段规定的路径）、DELETE（删除URL字段规定的文件）

5. HTTP状态响应码（位于服务器—>客户端的响应报文的首行）

   200-OK，301—Moved Permanently，400—Bad Request，404—Not Found，505—HTTP Version Not Supported

6. 用户-服务器状态：cookies（请求和响应报文各有cookies，客户端和服务器也有缓存）

7. Web缓存（代理服务器）与条件GET方法（condition get）：热点资源—二八法则

### 2.3.2 FTP

（略）

### 2.3.3 Email与SMPT、POP3

（略）

## 2.4 DNS

（人类用户提供要访问机器的“字符串”名称，由DNS负责转换为二进制的网络地址—IP）

DNS系统需要解决的问题（3个）（如何命名设备）（如何完成名字到IP地址的转换）（如何维护）

层次化的命名机制

分布式的数据库维护资源记录(RR)，来完成域名到IP地址的转换

运行在UDP之上的应用程序来响应域名解析的请求

## 2.5 P2P应用

(略)

## 2.6 CDN

（略）

## 2.7 TCP/UDP套接字

TCP建立socket步骤：

1. Server创建一个欢迎Socket（OS返回一串整数—welcome socket），然后捆绑IP+端口，最后阻塞式等待；
2. Client创建本地Socket（隐式捆绑本地port），指定Server进程的IP与端口，然后建立连接；
3. Server接受来自用户端的请求，解除阻塞式等待，返回一个新的连接Socket（与欢迎Socket不一样—connect socket），和客户端通信；
4. 连接API调用有效时，客户端P与服务器建立了TCP连接。

<img src="计算机网络漫游/TCP-socket.png" alt="TCP-socket" style="zoom:50%;" />

UDP建立socket特点：在客户端与服务器之间没有连接，传送的数据可能乱序，也可能丢失。

1. 没有握手
2. 发送端在每一个报文中明确地指定目标的IP地址和端口号
3. 服务器必须从收到的分组中提取发送端的IP地址和端口号

<img src="计算机网络漫游/UDP-socket.png" alt="UDP-socket" style="zoom:50%;" />

# Chapter 03 传输层

## 3.1 传输服务和协议

功能/服务：为运行在不同主机上的应用进程提供**逻辑通信**

方式：发送方将应用层的**报文**(message)**分成报文段**，然后传递给网络层；接收方将**报文段重组成报文**，然后传递给应用层。

可选协议簇：TCP和UDP

## 3.2 无连接传输：UDP（User Datagram Protocol）

服务：尽力而为，报文可能丢失，乱序

应用：流媒体、DNS、SNMP

改进可靠性：在应用层增加可靠性、应用特定的差错恢复

协议格式：

<img src="计算机网络漫游/UDP报文段格式.png" alt="UDP报文段格式" style="zoom:50%;" />

## 3.3 面向连接传输：TCP（Transmission Control Protocol）

协议格式：

<img src="计算机网络漫游/TCP报文段格式.png" alt="TCP报文段格式" style="zoom:50%;" />

可靠数据传输：累积确认；超时重传；快速重传；

流量控制：通过TCP段头部的接收窗口，通告空闲buffer大小

连接管理：在正式交换数据之前，发送方和接收方握手建立通信关系

<img src="计算机网络漫游/TCP3次握手.png" alt="TCP3次握手" style="zoom:50%;" />

TCP关闭连接

1. 客户端，服务器分别关闭它自己这一侧的连接

   发送FIB bit = 1的TCP段

2. 一旦接收到FIN，用ACK回应

   接收到FIN段，ACK可以和它自己发出的FIN段一起发送

3. 可以处理同时的FIN交换

<img src="计算机网络漫游/TCP关闭连接.png" alt="TCP关闭连接" style="zoom:50%;" />

对称释放，并不完美

## 3.4 网络拥塞与TCP拥塞控制

（略）

# Chapter 04 网络层—数据平面

## 4.1 路由与转发

路由—控制平面（应用层）：根据路由通告，决定到达目标端的下一跳路由器IP

转发—数据平面（网络层-链路层）：根据路由表决定从输入链路到达的数据报从哪个链路出去

2种路由-转发的实现：传统方式、SDN方式

## 4.2 IP数据报与IP分片、重组

<img src="计算机网络漫游/IP数据报.png" alt="IP数据报" style="zoom:50%;" />

IP分片：网络链路有MTU（链路层帧的所携带的最大数据长度），大的IP数据报分成小的数据报，各自有相同的IP报文头和不同的偏移量。

## 4.3 IPv4编址与子网（Subnets）

IPv4地址：子网部分（高位），主机部分（低位）

子网掩码：高位为1，低位为0的32位比特，与IP相与，得出主机的子网所在

层次编址：路由聚集，路由信息需要通告，先通告聚集，再发送ISP的路由器，以便分组转发时的路由表查询

## 4.4 DHCP（Dynamic host configuration protocol）

目标：允许主机在加入网络的时候，动态地从DHCP服务器那里获得IP地址

DHCP返回：

1. IP地址
2. 第一跳路由器的IP地址（默认网关）
3. DNS服务器的域名和IP地址
4. 子网掩码

## 4.4 通用转发和SDN

概括传统IP实现：网络层分为控制平面与数据平面，控制平面上的路由协议实体与其他路由器通信(做路由通告)，并计算路由表，数据平面上的IP协议实体根据路由表转发到来的分组

传统IP实现的缺点：垂直集成—>分布式铺设—>固化，导致代价大、升级困难、管理困难

SDN：逻辑上集中的控制平面

1. 网络数据交换设备的数据平面和控制平面分离
2. 数据平面—分组交换机：将路由器、交换机等设备的功能抽象成：按照流表（控制平面设置的控制逻辑）进行PDU（分组、帧）的动作（转发、丢弃、拷贝、泛洪、阻塞），由SDN交换机统一执行控制逻辑。
3. 控制平面—SDN控制器（OS）+ 网络应用

# Chapter 05 网络层—控制平面

## 5.1 路由选择算法

路由的概念：按照某种指标（传播延迟、所经过的站点数目等）找到一条从源节点到目标节点到较好路径

以网络(子网)为单位进行路由（路由信息通告+路由计算）

目标：得到一个汇集树

<img src="计算机网络漫游/汇集树.png" alt="汇集树" style="zoom:50%;" />



## 5.2 路由算法分类

1. 全局(Link State)：所有的路由器拥有完整的拓扑和边的代价的信息
2. 分布式(Distance Vector)：路由器只知道与它有物理连接关系的邻居路由器，和到相应邻居路由器的代价值

LS路由工作过程

1. 各点通过全局广播获得整个网络拓扑，网络中所有链路代价等信息
2. 使用Dijkstra路由算法，计算本站点到其他站点到最优路径（汇集树），得到路由表

DV算法

1. 各路由器维护一张路由表（目标(To)，下一个(Next)，代价(cost)）
2. 各路由器与相邻路由器通过局部传播交换路由表信息，通过动态规划更新路由表

## 5.3 因特网中自治系统内部的路由选择

距离矢量路由：RIP协议（Routing Information Protocol）

1. RIP以应用进程的方式实现
2. 通告报文通过UDP报文传送，周期性重复
3. 网络层的协议使用了传输层的服务，以应用层实体的方式实现
4. 适用于小型子网（不超过25个）

链路状态路由：OSPF协议

1. 大型网络支持层次性OSPF
2. 2个级别的层次性：本地和骨干

## 5.4 ISP之间的路由选择：BGP

层次路由：将互联网分成一个个AS（Autonomous Systems）

2个层次路由：

1. AS内部路由：在同一个AS内，路由器运行相同的路由协议（内部网关协议“intra-AS”—RIP，OSPF，IGRP）
2. AS间运行AS间路由协议：边界网关协议—BGP（Border Gateway Protoocl）

BGP：

1. 将互联网各个AS粘在一起的胶水

2. BGP提供给每个AS以下的方法

   eBGP：从相邻的ASes那里获得子网可达信息

   iBGP：将获得的子网可达信息传遍AS内部的所有路由器

3. 允许子网向互联网其他网络通过

4. 基于距离矢量算法（不仅有距离矢量，还包括到达各个目标网络的详细路径，AS序号的列表）

## 5.5 SDN控制平面

<img src="计算机网络漫游/SDN特点.png" alt="SDN特点" style="zoom:50%;" />

<img src="计算机网络漫游/SDN数据交换平面.png" alt="SDN数据交换平面" style="zoom:50%;" />

<img src="计算机网络漫游/SDN控制器.png" alt="SDN控制器" style="zoom:50%;" />

<img src="计算机网络漫游/SDN控制应用.png" alt="SDN控制应用" style="zoom:50%;" />

<img src="计算机网络漫游/SDN控制器里的元件.png" alt="SDN控制器里的元件" style="zoom:50%;" />

<img src="计算机网络漫游/SDN例子1.png" alt="SDN例子1" style="zoom:50%;" />



<img src="计算机网络漫游/SDN例子2.png" alt="SDN例子2" style="zoom:50%;" />

## 5.6 ICMP：因特网控制报文协议

ICMP：由主机、路由器、网关用于传达网络层控制信息

1. 错误报告：主机不可达、网络、端口、协议
2. Echo请求和回复（ping）

ICMP处在网络层，但是在IP协议的上面（ICMP消息由IP数据报承载）

## 5.7 网络管理和SNMP

（略）

# Chapter 06 链路层和局域网

## 6.1 一般链路层的服务

概述：数据链层负责从一个节点通过链路将（帧中的）数据报发送到相邻的物理节点（一个子网内部的两个物理连接的节点）

1. 封装成帧，链路接入：信道访问，MAC标识
2. 可靠传输：根据Ethenet还是WLAN
3. 流量控制：相邻节点的发送与接收的速率匹配
4. 错误检测：CRC循环冗余校验
5. 差错纠正：检错与纠正bit位
6. 半双工/全双工：双向还是单向

## 6.2 链路层的实现

主机、交换机、路由器的端口上，具体表现为一个适配器，在Ethenet内是802.3的以太网卡，接在主机的总线上，即硬件、软件和固件的综合体

## 6.3 多点访问协议

分布式算法—决定节点如何使用共享信道，即决定哪一个节点在什么时候可以发送

**MAC协议的分类**（三大类）

1. 信道划分

   把信道划分成小片（时间，频率，编码）

2. 随机访问

   信道不划分，允许冲突

   冲突后恢复

3. 依次轮流

   节点依次轮流

   但是有很多数据传输的节点可以获得较长的信道使用权

其中，随机访问（CSMA）适用于低负载，信道划分适用于高负载

CSMA/CD—802.3 Ethenet

CSMA/CA—802.11 WLAN

为什么在WLAN中使用CA，而不是CD

 **概述**：WLAN无法像LAN在事中进行碰撞检测（CD），而是在事前监听信道

1. 信道忙：在窗口当中随机选取一个回退值，并在信道空闲时递减这个值，若信道还是忙碌，则回退值不变
2. 信道空闲持续DIFS长度：则传输整个帧
3. 确认帧同样等待信道空闲持续SIFS长度：发送ACK

（DIFS > SIFS — 确认帧的优先级大于数据帧的优先级） 

（无线链路的特性，需要每帧确认）

## 6.4 MAC与ARP

32位IP地址：在IPv4中，数据报在前n-1跳都在子网之间，最后一跳，则在目标节点的子网之中

48位LAN（MAC/物理/以太网）地址：使帧从一个物理网卡传递到与其物理连接到另外一个网卡中

IP地址是分层的，MAC地址是平面的

ARP（Address Resolution Protocol）：

1. LAN中每一个节点都有一个ARP表，ARP中维护了IP到MAC到映射
2. 如需查询IP所在的MAC，在LAN中发送广播，MAC为48位全1

## 6.5 以太帧结构

<img src="计算机网络漫游/以太帧结构.png" alt="以太帧结构" style="zoom:50%;" />![以太帧结构(续)](计算机网络漫游/以太帧结构(续).png)

<img src="计算机网络漫游/以太帧结构.png" alt="以太帧结构" style="zoom:50%;" />![以太帧结构(续)](计算机网络漫游/以太帧结构(续).png)

以太网：无连接、不可靠的服务

以太网的MAC协议：采用二进制退避的CSMA/CD介质访问控制形式

## 6.6 Hubs和Switches

HUbs本质上是物理层的中继器，对多点接入来说是同一个碰撞域，只允许一个站点发送

Switches对帧进行存储和转发，端口执行以太网协议，根据目标MAC地址进行选择性的转发，可同时多路转发

# Chapter 07 Web页面请求的生命周期

场景：学术在校园启动一台笔记本电脑，请求和接收www.google.com

1. 笔记本需要一个IP地址，第一跳路由器的IP地址，DNS地址

2. 采用DHCP，DHCP请求封装在UDP中，封装IP分组，封装802.3以太网帧

3. 以太网帧在LAN上广播（dest：FFFFFFFFFFFF），被运行中的DHCP服务器接收到

4. 以太网帧中解封装IP分组，解封装UDP，解封装DHCP

5. DHCP服务器生产DHCP ACK，包含客户端IP地址，第一跳路由器IP地址和DNS服务器IP地址

6. 在DHCP服务器封装，帧通过LAN转发（交换机自学习），在客户端解封装

7. 客户端收到DHCP ACK应答

   （解决第一步需要的东西）

8. 在发送HTTP request请求之前，需要知道www.google.com的IP地址

9. 采用DNS，创建DNS查询，封装在UDP段中，封装IP数据报，封装以太网帧，将帧传递给路由器，但是需要知道路由器的接口，即端口的MAC地址

10. ARP查询广播，被路由器接收，路由器用ARP应答，给出其IP地址某个端口的MAC地址

11. 客户端现已知第一跳路由器MAC地址，现在可以发起DNS查询了

12. 包含了DNS查询的IP数据报通过LAN交换机转发，从客户端到第一跳路由器

13. IP数据报被转发，从校园达到comcast网络，路由（路由表被RIP，OSPF或BGP协议创建）到DNS服务器

14. DNS服务器收到以太网帧，解封装

15. DNS服务器回复给客户端：www.google.com的IP地址

16. 为了发送HTTP请求，客户端打开到达Web服务器的TCP socket

    TCP SYN段（3次握手的第1次握手）

    Web服务器用TCP SYNACK应答（3次握手的第2次握手）

    TCP连接建立了

17. HTTP请求发送到TCP socket中

18. IP数据报包含HTTP请求，最终路由到www.google.com

19. web服务器用HTTP应答回应（包含请求的页面）

20. IP数据报包含HTTP应答最后被路由到客户端

21. 最后，客户端接收HTTP应答，接收Html文件，调用一系列url加载对象，生成Google页面

